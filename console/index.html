<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="RICv2.js"></script>
        <style>
            body {
                width: 100%;
                height: 100%;

                display: flex;
                flex-direction: column;
                align-items: center;
            }

            #output {
                width: 80vw;
                height: 80vh;
                border: solid black 1px;

                overflow-y: scroll;
            }

            #output > div {
                display: flex;
                gap: 4px;

                border: solid rgb(195, 195, 195) 1px;
                padding: 2px 8px;
            }

            .who {
                flex: 0;
                min-width: 200px;
                width: 200px;

                display: flex;
                justify-content: right;
                align-items: center;
            }

            .time {
                flex: 0;
                min-width: 120px;
                width: 120px;

                display: flex;
                justify-content: left;
                align-items: center;
            }

            .message {
                flex: 1;

                display: flex;
                justify-content: right;
                align-items: center;
            }

            input[type=number] {
                width: 48px;
            }
        </style>
    </head>
    <body>
      <div id="output"></div>
      <form>
        <input type="number" style="width: 120px;" name="target" max="255" min="0" placeholder="target">
        <span >----</span>
        <input type="number" name="data20" max="255" min="0">
        <input type="number" name="data19" max="255" min="0">
        <input type="number" name="data18" max="255" min="0">
        <input type="number" name="data17" max="255" min="0">
        <input type="number" name="data16" max="255" min="0">
        <input type="number" name="data15" max="255" min="0">
        <input type="number" name="data14" max="255" min="0">
        <input type="number" name="data13" max="255" min="0">
        <input type="number" name="data12" max="255" min="0">
        <input type="number" name="data11" max="255" min="0">
        <input type="number" name="data10" max="255" min="0">
        <input type="number" name="data9" max="255" min="0">
        <input type="number" name="data8" max="255" min="0">
        <input type="number" name="data7" max="255" min="0">
        <input type="number" name="data6" max="255" min="0">
        <input type="number" name="data5" max="255" min="0">
        <input type="number" name="data4" max="255" min="0">
        <input type="number" name="data3" max="255" min="0">
        <input type="number" name="data2" max="255" min="0">
        <input type="number" name="data1" max="255" min="0">

        <input type="button" value="send">
      </form>
      <script>
        let output = document.querySelector("#output");

        let callback = (version,src,dst,tags,data)=>{
            let newEntry = document.createElement("div");
            
            let datetime = new Date();
            let time = `${datetime.getHours() < 10 ? "0" : ""}${datetime.getHours()}:${datetime.getMinutes() < 10 ? "0" : ""}${datetime.getMinutes()}:${datetime.getSeconds() < 10 ? "0" : ""}${(datetime.getSeconds() + datetime.getMilliseconds()/1000).toFixed(3)}`;

            if ((tags & 1) != 0) {
                //Conntected new
                let snooping_enabled = (tags & 2) != 0;

                newEntry.classList.add("conncted");
                newEntry.innerHTML = `
                    <div class="time">${time}</div>
                    <div class="who">${src}</div>
                    <div class="message">Connected ${snooping_enabled ? "(can snoop)" : ""}</div>
                    `;
            } else if ((tags & 128) != 0) {
                //Disconnected

                newEntry.classList.add("disconncted");
                newEntry.innerHTML = `
                    <div class="time">${time}</div>
                    <div class="who">${src}</div>
                    <div class="message">Disconnected</div>
                    `;
            } else {
                //Message

                newEntry.classList.add("message");
                newEntry.innerHTML = `
                    <div class="time">${time}</div>
                    <div class="who">Message from ${src} to ${dst}</div>
                    <div class="message">${data}</div>
                    `;
            }

            let shouldScrollDown = (output.scrollTopMax - output.scrollTop) < 40
            
            output.appendChild(newEntry);

            if (shouldScrollDown) newEntry.scrollIntoView();
        };

        let u = new URL(window.location);
        u.protocol = "ws";
        u.pathname = "/";
        u.hash = "";

        let ric = new RobotikInterConnect(Number(window.location.hash.replaceAll("#","")),callback,u.toString());
        
        let form = document.querySelector("form");
        form.reset();

        let button = document.querySelector("input[type=button]")
        button.addEventListener("click",(event)=>{
            let fd = new FormData(form);
            let target = Number(fd.get("target"));
            let arr = [];
            for (let i=20; i > 0; i--) {
                arr.push(Number(fd.get(`data${i}`)));
            }

            let data = new Uint8Array(arr);

            ric.send(target,0,data);
        });

      </script>
    </body>
</html>